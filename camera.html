<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC 카메라 프리뷰 캡처</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: flex-start;
      align-items: center;
    }
    #cameraPreview {
      width: 100%;
      height: 300px;
      background-color: #000;
    }
    #contentArea {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #capturedImage {
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- 카메라 프리뷰 -->
  <div id="cameraPreview"></div>

  <div id="contentArea">
    <button id="useButton">사용하기</button>
    <button id="uploadButton">업로드</button>
    <canvas id="capturedImage"></canvas> <!-- 캡처된 이미지를 그릴 캔버스 -->
  </div>

  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  <script>
    let videoElement;
    let stream;
    let capturedImageCanvas = document.getElementById("capturedImage");
    let context = capturedImageCanvas.getContext("2d");
    let capturedImageDataUrl = "";

    // 카메라 스트림을 가져오는 함수
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoElement = document.createElement('video');
        videoElement.srcObject = stream;
        videoElement.autoplay = true;
        videoElement.muted = true;
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        document.getElementById('cameraPreview').appendChild(videoElement);
      } catch (err) {
        console.error('카메라 접근 오류:', err);
      }
    }

    // 카메라 프리뷰 캡처하는 함수
    function captureImage() {
      const width = videoElement.videoWidth;
      const height = videoElement.videoHeight;
      capturedImageCanvas.width = width;
      capturedImageCanvas.height = height;

      // 비디오에서 이미지를 캡처하여 캔버스에 그리기
      context.drawImage(videoElement, 0, 0, width, height);

      // 캡처된 이미지를 Data URL로 변환
      capturedImageDataUrl = capturedImageCanvas.toDataURL('image/png');
      
      // 캡처된 이미지를 화면에 보여주기
      capturedImageCanvas.style.display = 'block';
    }

    // 이미지 업로드 함수
    async function uploadImage() {
      if (!capturedImageDataUrl) {
        alert("먼저 이미지를 캡처해 주세요.");
        return;
      }

      const formData = new FormData();
      const blob = dataURLtoBlob(capturedImageDataUrl);
      formData.append('image', blob, 'captured_image.png');

      try {
        const response = await fetch('http://localhost:8000/upload', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          alert("이미지 업로드 성공!");
        } else {
          alert("이미지 업로드 실패.");
        }
      } catch (error) {
        console.error("업로드 중 오류 발생:", error);
        alert("서버에 업로드하는 동안 오류가 발생했습니다.");
      }
    }

    // Data URL을 Blob으로 변환하는 함수
    function dataURLtoBlob(dataURL) {
      const byteString = atob(dataURL.split(',')[1]);
      const arrayBuffer = new ArrayBuffer(byteString.length);
      const uint8Array = new Uint8Array(arrayBuffer);

      for (let i = 0; i < byteString.length; i++) {
        uint8Array[i] = byteString.charCodeAt(i);
      }

      return new Blob([uint8Array], { type: 'image/png' });
    }

    // 버튼 클릭 이벤트 처리
    document.getElementById('useButton').onclick = captureImage;
    document.getElementById('uploadButton').onclick = uploadImage;

    // 페이지 로드 시 카메라 시작
    window.onload = startCamera;
  </script>
</body>
</html>
